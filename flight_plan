# ROS 2ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ Python í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê°€ì ¸ì˜¨ë‹¤
import rclpy

# ROS 2 ë…¸ë“œë¥¼ ë§Œë“¤ê¸° ìœ„í•œ Node í´ë˜ìŠ¤ë¥¼ ê°€ì ¸ì˜¨ë‹¤
from rclpy.node import Node

# PX4ì™€ í†µì‹ í•˜ê¸° ìœ„í•œ VehicleCommand ë©”ì‹œì§€ íƒ€ì…ì„ ê°€ì ¸ì˜¨ë‹¤
from px4_msgs.msg import VehicleCommand

# ëª…ë ¹ íƒ€ì´ë°ì„ ì œì–´í•˜ê¸° ìœ„í•œ time ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ê°€ì ¸ì˜¨ë‹¤
import time

# ììœ¨ ë¹„í–‰ì„ ìˆ˜í–‰í•  í´ë˜ìŠ¤ë¥¼ ì •ì˜í•œë‹¤. ROS 2ì˜ Nodeë¥¼ ìƒì†ë°›ëŠ”ë‹¤
class VTOLMissionNode(Node):
    def __init__(self):
        # ë…¸ë“œ ì´ˆê¸°í™”: ë…¸ë“œ ì´ë¦„ì€ 'vtol_mission_node'ë¡œ ì„¤ì •
        super().__init__('vtol_mission_node')

        # í¼ë¸”ë¦¬ì…” ìƒì„±: PX4ì— VehicleCommand ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê¸° ìœ„í•´ ì‚¬ìš©
        self.publisher_ = self.create_publisher(VehicleCommand, '/fmu/vehicle_command', 10)

        # 1ì´ˆë§ˆë‹¤ timer_callback í•¨ìˆ˜ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œ
        self.timer = self.create_timer(1.0, self.timer_callback)

        # í˜„ì¬ ìƒíƒœë¥¼ ì €ì¥í•˜ëŠ” ë³€ìˆ˜: ìƒíƒœ ë²ˆí˜¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¹„í–‰ ë‹¨ê³„ë¥¼ ë‚˜ëˆˆë‹¤
        self.state = 0

        # ë§ˆì§€ë§‰ ëª…ë ¹ì„ ë³´ë‚¸ ì‹œê°„ì„ ì €ì¥ (ì‹œê°„ ê°„ê²© ì œì–´ì— ì‚¬ìš©)
        self.last_command_time = time.time()

        # í˜„ì¬ ìƒíƒœì—ì„œ ëª…ë ¹ì„ ì´ë¯¸ ë³´ëƒˆëŠ”ì§€ë¥¼ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸
        self.sent = False

        # ë¯¸ì…˜ì— ì‚¬ìš©ë  ê²½ìœ ì§€(Waypoints) ë¦¬ìŠ¤íŠ¸: (ì´ë¦„, ìœ„ë„, ê²½ë„, ê³ ë„)ë¡œ êµ¬ì„±ë¨
        self.waypoints = [
            ('takeoff', 35.06919095325408, 128.08606072986328, 15),
            ('wp1', 35.069081359950346, 128.08622098022627, 20),
            ('wp2', 35.068719833160344, 128.08683558919387, 20),
            ('wp3', 35.06743692105997, 128.08717486716128, 20),
            ('wp4', 35.06843331656012, 128.08813088013784, 20),
            ('wp2_return', 35.068719833160344, 128.08683558919387, 20),
            ('rescue', 35.06949912196006, 128.08637177459477, 5),
            ('drop', 35.06890791418471, 128.08545950489426, 5),
        ]

    # íƒ€ì´ë¨¸ì— ì˜í•´ ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
    def timer_callback(self):
        # ëª¨ë“  ë¯¸ì…˜ì„ ì™„ë£Œí•œ ê²½ìš° ë…¸ë“œë¥¼ ì¢…ë£Œ
        if self.state >= len(self.waypoints) + 2:
            self.get_logger().info('âœ… Mission complete.')
            return

        # í˜„ì¬ ì‹œê°„ ì¸¡ì • (ê²½ê³¼ ì‹œê°„ íŒë‹¨ìš©)
        current_time = time.time()

        # ìƒíƒœ 0: ì´ë¥™ ëª…ë ¹ì„ ë³´ëƒ„
        if self.state == 0 and not self.sent:
            self.takeoff()
            self.sent = True

        # ìƒíƒœ 1: wp1ë¡œ ì´ë™ ëª…ë ¹ (5ì´ˆ ê¸°ë‹¤ë¦° í›„ ì „ì†¡)
        elif self.state == 1 and current_time - self.last_command_time > 5:
            self.send_waypoint(*self.waypoints[1])
            self.sent = True

        # ìƒíƒœ 2: ê³ ì •ìµ ì „í™˜ ëª…ë ¹ (10ì´ˆ í›„ ì‹¤í–‰)
        elif self.state == 2 and current_time - self.last_command_time > 10:
            self.transition_to_fixed_wing()
            self.sent = True

        # ìƒíƒœ 3~6: wp2 â†’ wp4 â†’ wp2_return ì´ë™ (ê° 10ì´ˆ ê°„ê²©)
        elif 3 <= self.state <= 6 and current_time - self.last_command_time > 10:
            self.send_waypoint(*self.waypoints[self.state - 1])
            self.sent = True

        # ìƒíƒœ 7: ë©€í‹°ì½¥í„° ëª¨ë“œë¡œ ì „í™˜
        elif self.state == 7 and current_time - self.last_command_time > 10:
            self.transition_to_multicopter()
            self.sent = True

        # ìƒíƒœ 8: êµ¬ì¡° ì§€ì ìœ¼ë¡œ ì´ë™
        elif self.state == 8 and current_time - self.last_command_time > 10:
            self.send_waypoint(*self.waypoints[6])
            self.sent = True

        # ìƒíƒœ 9: ë“œë¡­ ì§€ì ìœ¼ë¡œ ì´ë™
        elif self.state == 9 and current_time - self.last_command_time > 10:
            self.send_waypoint(*self.waypoints[7])
            self.sent = True

        # ìƒíƒœ 10: ì°©ë¥™ ëª…ë ¹
        elif self.state == 10 and current_time - self.last_command_time > 10:
            self.land()
            self.sent = True

        # ê·¸ ì™¸: ìƒíƒœê°€ ë°”ë€Œì—ˆê±°ë‚˜ ëª…ë ¹ì´ ëë‚œ í›„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê° (12ì´ˆ ëŒ€ê¸°)
        elif current_time - self.last_command_time > 12:
            self.state += 1
            self.last_command_time = current_time
            self.sent = False

    # ì´ë¥™ ëª…ë ¹ í•¨ìˆ˜
    def takeoff(self):
        cmd = self.make_command(22)  # 22 = VEHICLE_CMD_NAV_TAKEOFF
        cmd.param7 = 15.0  # ì´ë¥™ ê³ ë„ ì„¤ì •
        self.publisher_.publish(cmd)
        self.get_logger().info('ğŸš€ Sent takeoff command.')

    # ì°©ë¥™ ëª…ë ¹ í•¨ìˆ˜
    def land(self):
        cmd = self.make_command(21)  # 21 = VEHICLE_CMD_NAV_LAND
        self.publisher_.publish(cmd)
        self.get_logger().info('ğŸ›¬ Sent land command.')

    # ê³ ì •ìµìœ¼ë¡œ ì „í™˜í•˜ëŠ” ëª…ë ¹
    def transition_to_fixed_wing(self):
        cmd = self.make_command(3000)  # 3000 = VEHICLE_CMD_DO_VTOL_TRANSITION
        cmd.param1 = 1.0  # 1.0 = FIXED_WING
        self.publisher_.publish(cmd)
        self.get_logger().info('âœˆï¸ Transitioning to FIXED-WING.')

    # ë©€í‹°ì½¥í„°ë¡œ ì „í™˜í•˜ëŠ” ëª…ë ¹
    def transition_to_multicopter(self):
        cmd = self.make_command(3000)
        cmd.param1 = 0.0  # 0.0 = MULTICOPTER
        self.publisher_.publish(cmd)
        self.get_logger().info('ğŸŒ€ Transitioning to MULTICOPTER.')

    # íŠ¹ì • ìœ„ì¹˜(ìœ„ë„, ê²½ë„, ê³ ë„)ë¡œ ì´ë™í•˜ëŠ” ëª…ë ¹
    def send_waypoint(self, name, lat, lon, alt):
        cmd = self.make_command(16)  # 16 = VEHICLE_CMD_NAV_WAYPOINT
        cmd.param5 = lat   # ê²½ë„
        cmd.param6 = lon   # ìœ„ë„
        cmd.param7 = alt   # ê³ ë„
        self.publisher_.publish(cmd)
        self.get_logger().info(f'ğŸ“ Sent waypoint {name}: {lat}, {lon}, {alt}')

    # PX4 ëª…ë ¹ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ëŠ” ê³µí†µ í•¨ìˆ˜
    def make_command(self, command_type):
        cmd = VehicleCommand()
        # í˜„ì¬ ì‹œê°„ì„ ë§ˆì´í¬ë¡œì´ˆ ë‹¨ìœ„ë¡œ ì„¤ì •
        cmd.timestamp = int(self.get_clock().now().nanoseconds / 1000)
        cmd.command = command_type  # ëª…ë ¹ ì¢…ë¥˜
        cmd.target_system = 1       # íƒ€ê²Ÿ ì‹œìŠ¤í…œ ID
        cmd.target_component = 1    # íƒ€ê²Ÿ ì»´í¬ë„ŒíŠ¸ ID
        cmd.source_system = 1       # ì¶œë°œ ì‹œìŠ¤í…œ ID
        cmd.source_component = 1    # ì¶œë°œ ì»´í¬ë„ŒíŠ¸ ID
        cmd.from_external = True    # ì™¸ë¶€ì—ì„œ ë³´ë‚¸ ëª…ë ¹ì„ì„ í‘œì‹œ
        return cmd

# ì´ ìŠ¤í¬ë¦½íŠ¸ì˜ ë©”ì¸ ì§„ì…ì 
def main(args=None):
    rclpy.init(args=args)  # ROS 2 ì´ˆê¸°í™”
    node = VTOLMissionNode()  # ìœ„ì—ì„œ ì •ì˜í•œ ë…¸ë“œ í´ë˜ìŠ¤ ìƒì„±
    rclpy.spin(node)  # ë…¸ë“œë¥¼ ì‹¤í–‰í•˜ë©´ì„œ ì½œë°± í•¨ìˆ˜ë¥¼ ê³„ì† ëŒë¦¼
    node.destroy_node()  # ì¢…ë£Œ ì‹œ ë…¸ë“œ ì‚­ì œ
    rclpy.shutdown()  # ROS 2 ì¢…ë£Œ

# ì§ì ‘ ì‹¤í–‰í•  ê²½ìš° main() í•¨ìˆ˜ í˜¸ì¶œ
if __name__ == '__main__':
    main()
